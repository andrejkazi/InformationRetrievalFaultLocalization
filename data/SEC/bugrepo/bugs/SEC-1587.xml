<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Fri Dec 23 11:30:24 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/SEC-1587/SEC-1587.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[SEC-1587] HttpSessionSecurityContextRepository should clear session context when current context is anonmous or empty</title>
                <link>https://jira.spring.io/browse/SEC-1587</link>
                <project id="10040" key="SEC">Spring Security</project>
                    <description>&lt;p&gt;I have written a LogoutFilter which does not redirect to a logout page. It just logs out the user and goes on with the filter chain.&lt;br/&gt;
(it&apos;s needed because we have different areas and the user should be logged out when switching to another &quot;area&quot;)&lt;/p&gt;

&lt;p&gt;Before it comes to saving the security context with HttpSessionSecurityContextRepository the anonymousFilter sets an AnonymousAuthentication. So when it comes to saving the context, it is not saved.&lt;/p&gt;

&lt;p&gt;This is because of this code in HttpSessionSecurityContextRepository&lt;/p&gt;

&lt;p&gt;protected void saveContext(SecurityContext context) {&lt;br/&gt;
            // See &lt;a href=&quot;https://jira.spring.io/browse/SEC-776&quot; title=&quot;Http Session created for Anonymous request&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SEC-776&quot;&gt;&lt;del&gt;SEC-776&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
   if (authenticationTrustResolver.isAnonymous(context.getAuthentication())) {&lt;br/&gt;
                if (logger.isDebugEnabled()) &lt;/p&gt;
{
                    logger.debug(&quot;SecurityContext contents are anonymous - context will not be stored in HttpSession. &quot;);
                }
&lt;p&gt;                return;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;BTW my LogoutFilter is configured with invalidateHttpSession=false otherwise this bug wouldn&apos;t occur i guess.&lt;/p&gt;

&lt;p&gt;So imho, there should be another check to see what is actually saved in the session.&lt;/p&gt;

&lt;p&gt;regards&lt;br/&gt;
Janning&lt;/p&gt;</description>
                <environment></environment>
        <key id="33675">SEC-1587</key>
            <summary>HttpSessionSecurityContextRepository should clear session context when current context is anonmous or empty</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://jira.spring.io/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="luke">Luke Taylor</assignee>
                                    <reporter username="janning">Janning Vygen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Oct 2010 01:19:07 +0000</created>
                <updated>Sat, 6 Feb 2016 06:15:37 +0000</updated>
                            <resolved>Wed, 10 Nov 2010 05:06:31 +0000</resolved>
                                    <version>3.0.3</version>
                                    <fixVersion>3.0.5</fixVersion>
                    <fixVersion>3.1.0.M2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="59298" author="luke" created="Fri, 15 Oct 2010 09:42:55 +0000"  >&lt;p&gt;I don&apos;t really see what the bug is. It is intended that anonymous authentication tokens aren&apos;t store in the session.&lt;/p&gt;</comment>
                            <comment id="59334" author="janning" created="Sat, 16 Oct 2010 02:10:26 +0000"  >&lt;p&gt;hmm, it&apos;s quite clear to me &lt;img class=&quot;emoticon&quot; src=&quot;https://jira.spring.io/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; i&apos;ll try it again, if you still don&apos;t see the bug, i will try to create a test project.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;we have a userAuthentication saved in the session.&lt;/li&gt;
	&lt;li&gt;user clicks &quot;logout&quot;&lt;/li&gt;
	&lt;li&gt;first HttpSessionSecurityContextRepository loads the userAuthentication from the session into the SecurityContext&lt;/li&gt;
	&lt;li&gt;logoutfilter clears the securityContext in memory, but not in the session because of invalidateHttpSession=false&lt;/li&gt;
	&lt;li&gt;logoutfilter does not &quot;return&quot;, but calls filterChain.doFilter()&lt;/li&gt;
	&lt;li&gt;anonymousfilter sets anonymousAuthentication into SecurityContext&lt;/li&gt;
	&lt;li&gt;HttpSessionSecurityContextRepository does not save the current context to the session because its anonymous&lt;/li&gt;
	&lt;li&gt;userAuthentication is still saved in the session&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;on the next page HttpSessionSecurityContextRepository loads the userAuthentication from the session. user is still logged in.&lt;/p&gt;

&lt;p&gt;I think this bug only occurs if your logoutfilter does not call &quot;return&quot; but filter.doChain(). Maybe this is a bug in my LogoutFilter implementation. &lt;br/&gt;
But i think HttpSessionSecurityContextRepository should do an additional check to prevent situation like the one described above.&lt;/p&gt;

</comment>
                            <comment id="59418" author="luke" created="Mon, 18 Oct 2010 06:44:06 +0000"  >&lt;p&gt;Ok, I see what you mean now. The problem is that the original context is retained in the session when it should be removed. I&apos;ll take a look at how that can be accomodated. As a workaround you can probably just directly remove the context attribute from the session in your LogoutFilter (rather than invalidating the session as most users would require for a logout).&lt;/p&gt;</comment>
                            <comment id="60468" author="luke" created="Tue, 9 Nov 2010 05:39:59 +0000"  >&lt;p&gt;Hmm. Looking at this again, I&apos;m still not quite sure why it would happen (unless you are using clustering). The SecurityContext in the ThreadLocal should be the same instance as the one in the session (since that&apos;s where it&apos;s loaded from), so when it is overwritten, the one in the session should be also. It probably still makes sense to add a fix with an explicit removeAttribute() call when clustering is being used, but it would be useful if you could check again what is actually happening in your case.&lt;/p&gt;</comment>
                            <comment id="60514" author="luke" created="Wed, 10 Nov 2010 05:06:13 +0000"  >&lt;p&gt;I&apos;ve added appropriate checks in the context saving logic to explicitly call session.removeAttribute() when the security context is empty or anonymous.&lt;/p&gt;</comment>
                            <comment id="60527" author="janning" created="Wed, 10 Nov 2010 08:35:01 +0000"  >&lt;p&gt;From your previous post, i was just about starting to look at this again. But i think you already fixed it, right? If not, please send me a mail.&lt;/p&gt;</comment>
                            <comment id="60528" author="luke" created="Wed, 10 Nov 2010 09:04:24 +0000"  >&lt;p&gt;Yeah, I&apos;ve added the fix, but I&apos;m still not sure why it would be needed in a single-VM situation. &lt;/p&gt;</comment>
                            <comment id="60771" author="janning" created="Fri, 19 Nov 2010 00:55:14 +0000"  >&lt;p&gt;I have attached a maven test project. i hope it helps. if not please ask.&lt;/p&gt;

&lt;p&gt;the main reason for this to happen is:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LogoutFilter does not return after logout but continues with doChain&lt;/li&gt;
	&lt;li&gt;LogoutFilter does not invalidate session&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;please take a loolk at the source code. project is very small.&lt;br/&gt;
tets fails with 3.0.3, it succeeds with 3.0.5&lt;/p&gt;
</comment>
                            <comment id="60772" author="janning" created="Fri, 19 Nov 2010 00:57:14 +0000"  >&lt;p&gt;Maven test project&lt;/p&gt;</comment>
                            <comment id="124515" author="issuemaster" created="Sat, 6 Feb 2016 06:15:37 +0000"  >&lt;p&gt;This issue has been migrated to &lt;a href=&quot;https://github.com/spring-projects/spring-security/issues/1826&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/spring-projects/spring-security/issues/1826&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="17375" name="sec-1587.tar.gz" size="2156" author="janning" created="Fri, 19 Nov 2010 00:57:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 15 Oct 2010 09:42:55 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10280" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19399</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02unz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>16677</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10381" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Ranking</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>15695</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>