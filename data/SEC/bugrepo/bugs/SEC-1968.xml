<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Fri Dec 23 10:10:35 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/SEC-1968/SEC-1968.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[SEC-1968] PreAuthenticatedProcessingFilter does not clear out the security context causing user to unintentionally remain authenticated</title>
                <link>https://jira.spring.io/browse/SEC-1968</link>
                <project id="10040" key="SEC">Spring Security</project>
                    <description>&lt;p&gt;When the pre-authenticated user is null, the previously authenticated user&apos;s security context remains, and as such, the previous user remains authenticated.&lt;/p&gt;

&lt;p&gt;It seems like the AbstractPreAuthenticatedProcessingFilter should clear out the security context in doAuthenticate if the principal is null.  I can override the getPreAuthenticatedPrincipal call to do this (if I return  null for the principal), but it seems that this is not something the user should have to manage.  And, it seems like a side-effect / hack to put something like that in a method that should just be getting the principal, and doAuthenticate itself is private.  This is dangerous because later in the chain, in AbstractSecurityInterceptor.beforeInvocation(Object object) the security context is not null, even though it should be, and so, no exception is thrown from:&lt;/p&gt;

&lt;p&gt;        if (SecurityContextHolder.getContext().getAuthentication() == null) &lt;/p&gt;
{
            credentialsNotFound(messages.getMessage(&quot;AbstractSecurityInterceptor.authenticationNotFound&quot;,
                    &quot;An Authentication object was not found in the SecurityContext&quot;), object, attributes);
        }

&lt;p&gt;It could also possibly be argued that the security context should be cleared in AbstractPreAuthenticatedFilter.requiresAuthentication in the session invalidation on a principal change - namely in here:&lt;/p&gt;

&lt;p&gt;        if (invalidateSessionOnPrincipalChange) {&lt;br/&gt;
            HttpSession session = request.getSession(false);&lt;/p&gt;

&lt;p&gt;            if (session != null) &lt;/p&gt;
{
                logger.debug(&quot;Invalidating existing session&quot;);
                session.invalidate();
                request.getSession();
            }
&lt;p&gt;        }&lt;/p&gt;


&lt;p&gt;I have attached a test application that demonstrates this in the simplest format I could come up with. Basically the pre-authentication occurs by grabbing a username from a request parameter, and then it displays the logged in user&apos;s username on the home page.&lt;/p&gt;

&lt;p&gt;So if I go to &lt;a href=&quot;http://localhost:8080/security/?username=bob&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8080/security/?username=bob&lt;/a&gt; the application will display &apos;Hello bob&apos;.  If I hit &lt;a href=&quot;http://localhost:8080/security/?username=jimi&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8080/security/?username=jimi&lt;/a&gt;, it will switch to saying &apos;Hello jimi&apos;, but if I do &lt;a href=&quot;http://localhost:8080/security/?username=&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8080/security/?username=&lt;/a&gt; it will remain at &apos;Hello jimi&apos; (or whatever the previously authenticated user was), instead of requiring authentication.&lt;/p&gt;

&lt;p&gt;However, if in getPreAuthenticatedPrincipal() I call SecurityContextHolder.clearContext(), then hitting &lt;a href=&quot;http://localhost:8080/security/?username=&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8080/security/?username=&lt;/a&gt; will result in taking me to the login page which I think is the desired behavior if the user is not pre-authenticated - indicated by getPreAuthenticatedPrincipal() returning null.&lt;/p&gt;</description>
                <environment></environment>
        <key id="43626">SEC-1968</key>
            <summary>PreAuthenticatedProcessingFilter does not clear out the security context causing user to unintentionally remain authenticated</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://jira.spring.io/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rwinch">Rob Winch</assignee>
                                    <reporter username="mattmwheeler@gmail.com">Matt Wheeler</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 May 2012 10:21:06 +0000</created>
                <updated>Sat, 6 Feb 2016 06:19:37 +0000</updated>
                            <resolved>Wed, 27 Jun 2012 13:53:17 +0000</resolved>
                                    <version>3.0.7</version>
                    <version>3.1.0</version>
                                    <fixVersion>3.0.8</fixVersion>
                    <fixVersion>3.1.1</fixVersion>
                                    <component>Web</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                    <timeoriginalestimate seconds="57600">2d</timeoriginalestimate>
                            <timeestimate seconds="57600">2d</timeestimate>
                                        <comments>
                            <comment id="79696" author="rwinch" created="Thu, 7 Jun 2012 14:08:14 +0000"  >&lt;p&gt;@Matt - Thank you for your report and especially the detailed instructions on reproducing the issue. I believe you are correct that this is a bug and needs resolved.&lt;/p&gt;</comment>
                            <comment id="79756" author="mattmwheeler@gmail.com" created="Sat, 9 Jun 2012 15:48:06 +0000"  >&lt;p&gt;No problem.  Thank you for the great product.&lt;/p&gt;</comment>
                            <comment id="124926" author="issuemaster" created="Sat, 6 Feb 2016 06:19:37 +0000"  >&lt;p&gt;This issue has been migrated to &lt;a href=&quot;https://github.com/spring-projects/spring-security/issues/2192&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/spring-projects/spring-security/issues/2192&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="43186">SEC-1958</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="19707" name="test-spring-security.zip" size="10977" author="mattmwheeler@gmail.com" created="Wed, 30 May 2012 10:21:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 7 Jun 2012 14:08:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10280" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30969</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i05m4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32790</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10381" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Ranking</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30669</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>