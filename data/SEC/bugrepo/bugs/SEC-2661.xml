<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Fri Dec 23 11:05:10 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/SEC-2661/SEC-2661.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[SEC-2661] Eager instantiation in @EnableGlobalMethodSecurity can cause issues for user-defined beans</title>
                <link>https://jira.spring.io/browse/SEC-2661</link>
                <project id="10040" key="SEC">Spring Security</project>
                    <description>&lt;p&gt;There is a mess that you can get into with&lt;br/&gt;
&lt;tt&gt;@EnableGlobalMethodSecurity&lt;/tt&gt;. This annotation&lt;br/&gt;
lead to registration of an &lt;tt&gt;InfrastructureAdvisorAutoProxyCreator&lt;/tt&gt;&lt;br/&gt;
which is responsible for locating the `Advisor` bean that provides the&lt;br/&gt;
enabled feature. The mess is caused by aggressive bean instantiation&lt;br/&gt;
in that component which can cause cascades of unsafe bean instantation&lt;br/&gt;
in the middle of the bean post-processing phase of the&lt;br/&gt;
&lt;tt&gt;ApplicationContext&lt;/tt&gt; lifecycle (which is very early and quite&lt;br/&gt;
fragile). &lt;/p&gt;

&lt;p&gt;The net result is bad in two ways.&lt;/p&gt;

&lt;p&gt;1. Some beans end up uninitialized, or un-postprocessed, which is a&lt;br/&gt;
situation that Spring anticipates (since it logs the beans that are&lt;br/&gt;
screwed up in a &lt;tt&gt;BeanPostProcessorChecker&lt;/tt&gt; at INFO level, this is&lt;br/&gt;
plain to see for most users), but the side effects can be subtle.&lt;/p&gt;

&lt;p&gt;2. Any bean which is accidentally instantiated in this phase and tries&lt;br/&gt;
to publish an &lt;tt&gt;ApplicationEvent&lt;/tt&gt; is in for a nasty shock: the&lt;br/&gt;
&lt;tt&gt;ApplicationContext&lt;/tt&gt; is not ready for them yet and will barf in an&lt;br/&gt;
ugly and confusing way, saying that it is not yet &quot;refreshed&quot;.&lt;/p&gt;

&lt;p&gt;Things are bad with &lt;tt&gt;@EnableGlobalMethodSecurity} because its {{Advisor&lt;/tt&gt; doesn&apos;t defer the&lt;br/&gt;
instantiation of its dependencies. It needs an &lt;tt&gt;AuthenticationManager&lt;/tt&gt;&lt;br/&gt;
at runtime, and users can put the whole kitchen sink into their&lt;br/&gt;
&lt;tt&gt;AuthenticationManager&lt;/tt&gt; (e.g. JPA), so practically the whole bean&lt;br/&gt;
registry can be aggressively instantiated by the user inadvertently&lt;br/&gt;
(and reasonably) using Spring to configure his authentication&lt;br/&gt;
requirements.&lt;/p&gt;</description>
                <environment></environment>
        <key id="58334">SEC-2661</key>
            <summary>Eager instantiation in @EnableGlobalMethodSecurity can cause issues for user-defined beans</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://jira.spring.io/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="rwinch">Rob Winch</assignee>
                                    <reporter username="david_syer">Dave Syer</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Jun 2014 06:41:38 +0000</created>
                <updated>Sat, 6 Feb 2016 06:25:47 +0000</updated>
                            <resolved>Tue, 27 Jan 2015 10:16:07 +0000</resolved>
                                                    <fixVersion>3.2.6</fixVersion>
                    <fixVersion>4.0.0.RC2</fixVersion>
                                        <due></due>
                            <votes>3</votes>
                                    <watches>10</watches>
                                    <timeoriginalestimate seconds="57600">2d</timeoriginalestimate>
                            <timeestimate seconds="0">0d</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="105506" author="rwinch" created="Tue, 8 Jul 2014 14:24:00 +0000"  >&lt;p&gt;Note this seems to be related to &lt;a href=&quot;http://stackoverflow.com/questions/24598959/spring-boot-security-cannot-customize-security-when-running-on-embedded-tomc/24641807#24641807&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://stackoverflow.com/questions/24598959/spring-boot-security-cannot-customize-security-when-running-on-embedded-tomc/24641807#24641807&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="112001" author="rwinch" created="Tue, 27 Jan 2015 10:16:07 +0000"  >&lt;p&gt;While this issue was created after it didn&apos;t have a concrete example to reproduce the issue. The work for this issue was done on &lt;a href=&quot;https://jira.spring.io/browse/SEC-2815&quot; title=&quot;@EnableGlobalMethodSecurity prevents postprocessing of DataSource bean&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SEC-2815&quot;&gt;&lt;del&gt;SEC-2815&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A few notes about the issue:&lt;/p&gt;

&lt;p&gt;The issue is related to the &lt;tt&gt;GlobalMethodSecurityConfiguration&lt;/tt&gt; requiring a Bean &lt;tt&gt;AuthenticationConfiguration&lt;/tt&gt; that depends on non-infrastructure related Beans. Specifically the following happens:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Spring&apos;s &lt;tt&gt;AspectJAwareAdvisorAutoProxyCreator&lt;/tt&gt; requires all Advisor (i.e. &lt;tt&gt;metaDataSourceAdvisor&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;This in turn attempts to resolve the &lt;tt&gt;metaDataSourceAdvisor&lt;/tt&gt;, but in order to resolve the &lt;tt&gt;metaDataSourceAdvisor&lt;/tt&gt; Bean the&lt;br/&gt;
 &lt;tt&gt;GlobalMethodSecurityConfiguration&lt;/tt&gt; needs to be resolved&lt;/li&gt;
	&lt;li&gt;In order to resolve &lt;tt&gt;GlobalMethodSecurityConfiguration&lt;/tt&gt; all of the &lt;tt&gt;@Autowired&lt;/tt&gt; fields and methods need to be resolved. This includes &lt;tt&gt;GlobalMethodSecurityConfiguration#setAuthenticationConfiguration&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;AuthenticationConfiguration&lt;/tt&gt; requires all &lt;tt&gt;GlobalAuthenticationConfigurerAdapter&lt;/tt&gt; to be resolved.&lt;/li&gt;
	&lt;li&gt;Since &lt;tt&gt;GlobalAuthenticationConfigurerAdapter&lt;/tt&gt; contains a Bean &lt;tt&gt;DummyRepository&lt;/tt&gt; that refers to the &lt;tt&gt;DataSource&lt;/tt&gt;, the &lt;tt&gt;DataSource&lt;/tt&gt; is created eagerly.&lt;/li&gt;
	&lt;li&gt;That means that &lt;tt&gt;DataSourceInitializedPublisher&lt;/tt&gt; never sees the &lt;tt&gt;DataSource&lt;/tt&gt; in its &lt;tt&gt;postProcessAfterInitialization&lt;/tt&gt; method since the &lt;tt&gt;DataSource&lt;/tt&gt; is created before &lt;tt&gt;DataSourceInitializedPublisher&lt;/tt&gt;  is registered. This is a general problem with &lt;tt&gt;DataSourceInitializedPublisher&lt;/tt&gt; in that it expects to be the Bean that post processes &lt;tt&gt;DataSource&lt;/tt&gt; and &lt;tt&gt;EntityManagerFactory&lt;/tt&gt; (in that order).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can find a minimum reproducible test (with no dependency on Spring Security) at &lt;a href=&quot;https://jira.spring.io/browse/SEC-2815&quot; title=&quot;@EnableGlobalMethodSecurity prevents postprocessing of DataSource bean&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SEC-2815&quot;&gt;&lt;del&gt;SEC-2815&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://github.com/rwinch/spring-security-sample/tree/SEC-2815&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/rwinch/spring-security-sample/tree/SEC-2815&lt;/a&gt;). Note that none of the Advice Beans have any external dependencies. HEAD~1 of the same branch demonstrates the issue with Spring Security.&lt;/p&gt;

&lt;p&gt;To resolve this we lazily lookup the AuthenticationConfiguration using the ApplicationContext.&lt;/p&gt;

&lt;p&gt;You can see &lt;a href=&quot;https://github.com/spring-projects/spring-security/commit/62649af0aa07b9681e4679a2fa56112a7e3b98cf&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/spring-projects/spring-security/commit/62649af0aa07b9681e4679a2fa56112a7e3b98cf&lt;/a&gt; for the changes&lt;/p&gt;</comment>
                            <comment id="125684" author="issuemaster" created="Sat, 6 Feb 2016 06:25:47 +0000"  >&lt;p&gt;This issue has been migrated to &lt;a href=&quot;https://github.com/spring-projects/spring-security/issues/2881&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/spring-projects/spring-security/issues/2881&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10130">
                    <name>Supersede</name>
                                                                <inwardlinks description="is superseded by">
                                        <issuelink>
            <issuekey id="61735">SEC-2815</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 8 Jul 2014 14:24:00 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10280" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>44497</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07mz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>44594</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10381" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Ranking</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>44199</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10120" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>Reference URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://gist.github.com/dsyer/ebeb25d5afbdd9242cd5]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>