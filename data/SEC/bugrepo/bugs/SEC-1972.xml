<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Fri Dec 23 10:16:46 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/SEC-1972/SEC-1972.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[SEC-1972] OpenID4JavaConsumer throws an NPE</title>
                <link>https://jira.spring.io/browse/SEC-1972</link>
                <project id="10040" key="SEC">Spring Security</project>
                    <description>&lt;p&gt;Consider the following scenario:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;A relying party application is in a multi-JVM Tomcat cluster (we&apos;ll reference to these as instances A and B)&lt;/li&gt;
	&lt;li&gt;A user initiates OpenID authentication on instance A and is redirected to the OpenID provider&lt;/li&gt;
	&lt;li&gt;Before the user is returned to the relying party by the OpenID provider, instance A goes down and the load balancer begins sending all traffic to instance B&lt;/li&gt;
	&lt;li&gt;The user authenticates and is returned to the relying party application (instance B)&lt;/li&gt;
	&lt;li&gt;Final validation on instance B fails (in my case, direct verification of the signature failed) and the OpenID4JavaConsumer attempts to create a failed authentication response&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This breaks down because, in the beginConsumption() method, OpenID4JavaConsumer performs discovery and stores the resulting DiscoveryInformation object in the HttpSession object off of the current HttpServletRequest. When authentication fails, the following lines are executed in OpenID4JavaConsumer&apos;s endConsumption() method:&lt;/p&gt;

&lt;p/&gt;
&lt;div id=&quot;syntaxplugin&quot; class=&quot;syntaxplugin&quot; style=&quot;border: 1px dashed #bbb; border-radius: 5px !important; overflow: auto; max-height: 30em;&quot;&gt;
&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; width=&quot;100%&quot; style=&quot;font-size: 1em; line-height: 1.4em !important; font-weight: normal; font-style: normal; color: black;&quot;&gt;
		&lt;tbody &gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;  margin-top: 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;        if (verified == null) {&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;            Identifier id = discovered.getClaimedIdentifier();&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;            return new OpenIDAuthenticationToken(OpenIDAuthenticationStatus.FAILURE,&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;                    id == null ? &quot;Unknown&quot; : id.getIdentifier(),&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;                    &quot;Verification status message: [&quot; + verification.getStatusMsg() + &quot;]&quot;, attributes);&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   margin-bottom: 10px;  width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;        }&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
			&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p/&gt;

&lt;p&gt;The &quot;discovered&quot; object is a DiscoveryInformation object pulled from the HttpSession object off of the current HttpServletRequest object. In this event, it is null because it&apos;s a new session (difference Tomcat instance, in this case), and so the previously-stored DiscoveryInformation object was lost. The attempt, then, to pull the Identifier object off of the null DiscoveryInformation will throw an NPE at this point.&lt;/p&gt;

&lt;p&gt;My recommendation for fixing this would be to allow a consumer to inject (through, say, a DiscoveryInformationStorageStrategy interface) the means by which the DiscoveryInformation object is persisted. I&apos;ve hacked around this using an HttpSession object that actually delegates to writing the serialized DiscoveryInformation to a cookie (and reading it from that same cookie), but, as I said, it&apos;s a hack, and I don&apos;t like hacks. &lt;img class=&quot;emoticon&quot; src=&quot;https://jira.spring.io/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="43883">SEC-1972</key>
            <summary>OpenID4JavaConsumer throws an NPE</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://jira.spring.io/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Complete</resolution>
                                        <assignee username="rwinch">Rob Winch</assignee>
                                    <reporter username="jrh3k5">Joshua Hyde</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Jun 2012 10:27:36 +0000</created>
                <updated>Sat, 6 Feb 2016 06:19:40 +0000</updated>
                            <resolved>Tue, 2 Oct 2012 14:38:32 +0000</resolved>
                                    <version>3.0.7</version>
                                    <fixVersion>3.0.8</fixVersion>
                                    <component>OpenID</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <timeoriginalestimate seconds="7200">0.25d</timeoriginalestimate>
                            <timeestimate seconds="7200">0.25d</timeestimate>
                                        <comments>
                            <comment id="80041" author="rwinch" created="Sat, 16 Jun 2012 13:45:34 +0000"  >&lt;p&gt;I think there are three separate things happening here.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The first is a bug and has been fixed in the 3.1.x branch in &lt;a href=&quot;https://jira.spring.io/browse/SEC-1753&quot; title=&quot;Replay of response causes  NullPointerException in  OpenID4JavaConsumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SEC-1753&quot;&gt;&lt;del&gt;SEC-1753&lt;/del&gt;&lt;/a&gt;. I can use this JIRA to put a fix in the 3.0.x branch since Spring Security should be throwing a &lt;tt&gt;OpenIDConsumerException&lt;/tt&gt; not a &lt;tt&gt;NullPointerException&lt;/tt&gt;. Note that this bug can happen even in a non-clustered environment (i.e. the &lt;tt&gt;HttpSession&lt;/tt&gt; times out).&lt;/li&gt;
	&lt;li&gt;The second is an enhancement request to support other means of storing the &lt;tt&gt;DiscoveryInformation&lt;/tt&gt;. I think that this is a reasonable request and I already consider it to be included in &lt;a href=&quot;https://jira.spring.io/browse/SEC-1769&quot; title=&quot;Decouple from HttpSession&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SEC-1769&quot;&gt;&lt;del&gt;SEC-1769&lt;/del&gt;&lt;/a&gt;. This was not explicitly called out, so I went ahead and added &lt;a href=&quot;https://jira.spring.io/browse/SEC-1973&quot; title=&quot;OpenID4JavaConsumer should be decoupled from HttpSession&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SEC-1973&quot;&gt;&lt;del&gt;SEC-1973&lt;/del&gt;&lt;/a&gt; as a subtask to abstract out the &lt;tt&gt;HttpSession&lt;/tt&gt; from &lt;tt&gt;OpenID4JavaConsumer&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;The last is that it seems there is a concern that Spring Security is not working properly with fail over in a clustered environment. To me this seems like a setup issue. In order to support fail over, you should enable session replication in which case this would not be a problem.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="80061" author="jrh3k5" created="Mon, 18 Jun 2012 07:09:24 +0000"  >&lt;p&gt;That all sounds good and reasonable to me. Thanks, Rob.&lt;/p&gt;</comment>
                            <comment id="124931" author="issuemaster" created="Sat, 6 Feb 2016 06:19:40 +0000"  >&lt;p&gt;This issue has been migrated to &lt;a href=&quot;https://github.com/spring-projects/spring-security/issues/2196&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/spring-projects/spring-security/issues/2196&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 16 Jun 2012 13:45:34 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10280" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31184</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i05nfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33003</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10381" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Ranking</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30884</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>