<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Thu Dec 22 20:56:09 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/SPR-1316/SPR-1316.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[SPR-1316] JdkDynamicAopProxy massages return value even if it does not implements the expected return type</title>
                <link>https://jira.spring.io/browse/SPR-1316</link>
                <project id="10000" key="SPR">Spring Framework</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I faced an issue that looks like a Spring AOP bug.&lt;br/&gt;
When the JdkDynamicAopProxy return value is the target, it is replaced it by the proxy.&lt;br/&gt;
In the code it is commented as // massage return value if necessary&lt;/p&gt;

&lt;p&gt;Unfortunately, this replacement can be done unnecessary. It can replace the return value even when the proxy does not implement the return type of the method. It leads to java.lang.ClassCastException in the object $Proxy0 (the java.lang.reflect.Proxy).&lt;/p&gt;

&lt;p&gt;There should be a test case attached, if I find how to do it in Jira.&lt;br/&gt;
Briefly, it occurs when a proxied object implements two interfaces and only one is proxied. If the a result of the first interface (proxied) is of the type of the second interface (not proxied), the return will be the single instance of the object implementing both interfaces. JdkDynamicAopProxy determines that the return values and the target of aop are the same and returns the proxy even if it does not implements the expected type (second interface not proxied). Then the java.lang.reflect.Proxy throws a ClassCastException (without any message).&lt;/p&gt;

&lt;p&gt;I know, that other designs in the interfaces and/or implementation may avoid this issue, but I can&apos;t change &quot;legacy&quot; code.&lt;/p&gt;

&lt;p&gt;I suggest you a fix. At the end of the method invoke in JdkDynamicAopProxy, you could add a piece of code like the following.&lt;/p&gt;

&lt;p&gt;                                                               // massage return value if necessary&lt;br/&gt;
			if (retVal != null &amp;amp;&amp;amp; retVal == target) {&lt;br/&gt;
				// Special case: it returned &quot;this&quot;.&lt;br/&gt;
				// Note that we can&apos;t help if the target sets&lt;br/&gt;
				// a reference to itself in another returned object.&lt;br/&gt;
				if (method.getReturnType().isInstance(proxy) ) &lt;/p&gt;
{
					// Exchange with the proxy only when the proxy can be casted
					// to the return type.
					//The invocation returned an object, therefore the method
					// return type should not be null. Isn&apos;t it?
										
					retVal = proxy;
				}
&lt;p&gt;			}&lt;br/&gt;
			return retVal;&lt;/p&gt;

&lt;p&gt;There is another workaround, CGLIB can be used instead of JDK dynamic proxy.&lt;/p&gt;

&lt;p&gt;May you tell me if you consider it as a bug?&lt;br/&gt;
If so, may you give me some hints about a release number and date? &lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;

&lt;p&gt;Stephane Lemaire&lt;/p&gt;</description>
            <key id="12410">SPR-1316</key>
            <summary>JdkDynamicAopProxy massages return value even if it does not implements the expected return type</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://jira.spring.io/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="robh">Rob Harrop</assignee>
                                    <reporter username="slemaire">Stephane Lemaire</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Sep 2005 19:22:30 +0000</created>
                <updated>Tue, 19 Jun 2012 03:54:08 +0000</updated>
                            <resolved>Mon, 3 Oct 2005 21:34:24 +0000</resolved>
                                    <version>1.2.4</version>
                                    <fixVersion>1.2.6</fixVersion>
                                    <component>Core:AOP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="14882" author="robh" created="Mon, 3 Oct 2005 21:34:24 +0000"  >&lt;p&gt;Committed fix and test&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="11158" name="spr-1316.zip" size="2626" author="slemaire" created="Wed, 21 Sep 2005 19:25:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_10180" key="com.atlassian.jira.toolkit:dayslastcommented">
                        <customfieldname>Days since last comment</customfieldname>
                        <customfieldvalues>
                                        11 years, 13 weeks, 2 days ago
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 3 Oct 2005 21:34:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10181" key="com.atlassian.jira.toolkit:lastusercommented">
                        <customfieldname>Last commented by a User</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>false</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10182" key="com.atlassian.jira.toolkit:lastupdaterorcommenter">
                        <customfieldname>Last updater</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tmarshall</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i04w8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>28597</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>