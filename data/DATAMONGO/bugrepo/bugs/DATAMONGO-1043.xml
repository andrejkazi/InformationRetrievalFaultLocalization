<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Thu Dec 22 15:30:52 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/DATAMONGO-1043/DATAMONGO-1043.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[DATAMONGO-1043] SpEL Expressions in @Document annotations are not re-evaluated for query executions</title>
                <link>https://jira.spring.io/browse/DATAMONGO-1043</link>
                <project id="10701" key="DATAMONGO">Spring Data MongoDB</project>
                    <description>&lt;p&gt;Based on the idea of Oliver Gierke in &lt;a href=&quot;https://jira.spring.io/browse/DATAMONGO-525&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://jira.spring.io/browse/DATAMONGO-525&lt;/a&gt; I followed some post like the ones below&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://stackoverflow.com/questions/18129291/mongodb-and-spel-expressions-in-document-annotations&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://stackoverflow.com/questions/18129291/mongodb-and-spel-expressions-in-document-annotations&lt;/a&gt;&lt;br/&gt;
and&lt;br/&gt;
&lt;a href=&quot;http://stackoverflow.com/questions/19807733/mongodb-multi-tenacy-spel-with-document?rq=1&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://stackoverflow.com/questions/19807733/mongodb-multi-tenacy-spel-with-document?rq=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;but in the end I realized that the problem is that &lt;tt&gt;AbstractMongoQuery&lt;/tt&gt; is cached between requests(maybe a problem in my config?), and its query-method object of type &lt;tt&gt;MongoQueryMethod&lt;/tt&gt;, which holds the metadata, &lt;tt&gt;MongoEntityMetadata&lt;/tt&gt;. And thus make this approach (use SpEL in &lt;tt&gt;@Document&lt;/tt&gt; annotation) not fully working.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;AbstractMongoQuery&lt;/tt&gt; deals with different kind of executions. All of them but &lt;tt&gt;SingleEntityExecution&lt;/tt&gt; suffers from this problem, and it&apos;s because in &lt;tt&gt;SingleEntityExecution&lt;/tt&gt; &lt;tt&gt;mongoOperations&lt;/tt&gt; is called without passing &lt;tt&gt;collectionName&lt;/tt&gt; and thus letting, in the end, &lt;tt&gt;BasicMongoPersistentEntity.getCollection&lt;/tt&gt; apply &lt;tt&gt;SpEL&lt;/tt&gt; over entity class to obtain the runtime collection name.&lt;/p&gt;</description>
                <environment>Windows 8.1, jdk8</environment>
        <key id="59527">DATAMONGO-1043</key>
            <summary>SpEL Expressions in @Document annotations are not re-evaluated for query executions</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://jira.spring.io/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="olivergierke">Oliver Gierke</assignee>
                                    <reporter username="jllachf">Jordi Llach Fernandez</reporter>
                        <labels>
                            <label>mongodb</label>
                    </labels>
                <created>Mon, 1 Sep 2014 05:30:48 +0000</created>
                <updated>Tue, 27 Jan 2015 10:29:29 +0000</updated>
                            <resolved>Fri, 28 Nov 2014 11:27:09 +0000</resolved>
                                    <version>1.5.2 (Dijkstra SR2)</version>
                                    <fixVersion>1.7 M1 (Fowler)</fixVersion>
                    <fixVersion>1.5.5 (Dijkstra SR5)</fixVersion>
                    <fixVersion>1.6.2 (Evans SR2)</fixVersion>
                                    <component>Repository</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="107404" author="jllachf" created="Mon, 1 Sep 2014 09:08:47 +0000"  >
&lt;p&gt;It seems that metadata object of type &lt;tt&gt;MongoEntityMetadata&lt;/tt&gt; that belongs to &lt;tt&gt;MongoQueryMethod&lt;/tt&gt; is updated only once in method &lt;tt&gt;getEntityInformation()&lt;/tt&gt; , because &lt;tt&gt;QueryMethod&lt;/tt&gt; object that holds a reference to this seems to be pooled/cached by infrastructure code makes @Document annotations with Spel useless (once cached never changes)&lt;/p&gt;

&lt;p&gt;Default methods like findAll findOne provided out of the box (&lt;tt&gt;SimpleMongoRepository&lt;/tt&gt;) do not have this problem.&lt;/p&gt;

&lt;p&gt;From my point of view(and knowledge &lt;img class=&quot;emoticon&quot; src=&quot;https://jira.spring.io/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ) there are just three choices, &lt;/p&gt;

&lt;p&gt;1) recreate the metadata ( &lt;tt&gt;SimpleMongoEntityMetadata&lt;/tt&gt;) each time a call to &lt;tt&gt;getEntityInformation&lt;/tt&gt; is done&lt;br/&gt;
2) make object &lt;tt&gt;SimpleMongoEntityMetadata&lt;/tt&gt; which implements interface &lt;tt&gt;MongoEntityMetadata&lt;/tt&gt; mutable, and therefore changing interface signature :|&lt;br/&gt;
3) modify all Execution inner classes defined in &lt;tt&gt;AbstractMongoQuery&lt;/tt&gt; in order to let  injected &lt;tt&gt;MongoOperations&lt;/tt&gt; guess the correrct collection name at runtime&lt;/p&gt;

&lt;p&gt;Ups ... I forgot , as a workaround I am using MongoOperations in my custom repository xxxImpl, but I think that it would be quite useful for everyone&lt;/p&gt;

&lt;p&gt;Thanks in advance&lt;/p&gt;</comment>
                            <comment id="107462" author="jllachf" created="Wed, 3 Sep 2014 01:09:17 +0000"  >&lt;p&gt;As the number of @Repository beans in my project increase I&apos;ve tried to use AOP in order to modify this behaviour, by setting a null collection name in &lt;tt&gt;MongoEntityMetadata&lt;/tt&gt; but this does not help because changes in &lt;tt&gt;AbstractMongoQuery&lt;/tt&gt; inner classes, that implement &lt;tt&gt;Execution&lt;/tt&gt; interface, would also need to be done in order to check if &lt;tt&gt;MongoEntityMetadata&lt;/tt&gt; collection name is null and use a different &lt;tt&gt;MongoTemplate&lt;/tt&gt; method signature. &lt;br/&gt;
The point is that &lt;tt&gt;MongoTemplate&lt;/tt&gt; is smart enough to guess the right collection name by using its private method &lt;br/&gt;
&lt;tt&gt;determineEntityCollectionName&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="109396" author="jllachf" created="Thu, 6 Nov 2014 15:52:11 +0000"  >&lt;p&gt;As by Spring4.1.x SpEL compiler as improved its performance (&lt;a href=&quot;http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/html/expressions.html#expressions-compiler-configuration&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/html/expressions.html#expressions-compiler-configuration&lt;/a&gt;) I think that it could be a plausible solution to create a &lt;tt&gt;SimpleMongoEntityMetadata&lt;/tt&gt; by using the &lt;tt&gt;MongoPersistentEntity&lt;/tt&gt;, and not its collectionName. &lt;/p&gt;

&lt;p&gt;I have also made a PR to let you check my idea &lt;a href=&quot;https://github.com/spring-projects/spring-data-mongodb/pull/238&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/spring-projects/spring-data-mongodb/pull/238&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Maybe &lt;tt&gt;StandardEvaluationContext&lt;/tt&gt; should be reviewed when creating &lt;tt&gt;SpelExpressionParser&lt;/tt&gt; in order to use this configuration enhancement available in 4.1.x&lt;/p&gt;</comment>
                            <comment id="110164" author="olivergierke" created="Fri, 28 Nov 2014 11:07:29 +0000"  >&lt;p&gt;I&apos;ve applied a reduced version of your pull request to master and the bugfix branches. &lt;tt&gt;SimpleMongoEntityMetadata&lt;/tt&gt; now keeps a reference to the &lt;tt&gt;MongoPersistentEntity&lt;/tt&gt; and thus delegates calls to &lt;tt&gt;getCollectionName()&lt;/tt&gt; on each invocation. Feel free to give the snapshot builds a spin.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 28 Nov 2014 11:07:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10280" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>45685</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10182" key="com.atlassian.jira.toolkit:lastupdaterorcommenter">
                        <customfieldname>Last updater</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>olivergierke</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10684" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>Pull Request URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://github.com/spring-projects/spring-data-mongodb/pull/238]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07tfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>45640</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10381" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Ranking</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>45387</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10120" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>Reference URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://jira.spring.io/browse/DATAMONGO-525]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>