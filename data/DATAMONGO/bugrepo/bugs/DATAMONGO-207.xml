<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Thu Dec 22 15:31:34 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/DATAMONGO-207/DATAMONGO-207.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[DATAMONGO-207] MappingMongoConverter fails when reading empty java.util.SortedMaps</title>
                <link>https://jira.spring.io/browse/DATAMONGO-207</link>
                <project id="10701" key="DATAMONGO">Spring Data MongoDB</project>
                    <description>&lt;p&gt;Reading empty maps from mongoDB works fine for usual Maps such as LinkedHashMaps.&lt;br/&gt;
When using other interface types such as SortedMaps it fails because it does not safely detect these maps.&lt;/p&gt;

&lt;p&gt;I attached a test with 4 methods of which 1 is failing.&lt;br/&gt;
All test methods insert an entity containing 2 empty maps with one map being a java.util.Map and the other one a java.util.SortedMap.&lt;br/&gt;
When inserting the entity with empty maps Spring Data Document does not add any &quot;_class&quot; property to both of the map instances.&lt;br/&gt;
When reading them again the MappingMongoConverter tries to instanciate both maps with a LinkedHashMap which fails for the java.util.SortedMap (see method testFindListWithResultAndEmptyValues)&lt;/p&gt;

&lt;p&gt;This issue might be similar to &lt;a href=&quot;https://jira.spring.io/browse/DATAMONGO-192&quot; title=&quot;MappingMongoConverter does not read empty Sets correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DATAMONGO-192&quot;&gt;&lt;del&gt;DATAMONGO-192&lt;/del&gt;&lt;/a&gt; which was related to java.util.List(s)?&lt;/p&gt;</description>
                <environment></environment>
        <key id="40510">DATAMONGO-207</key>
            <summary>MappingMongoConverter fails when reading empty java.util.SortedMaps</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://jira.spring.io/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="olivergierke">Oliver Gierke</assignee>
                                    <reporter username="florian.feigenbutz">Florian Feigenbutz</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Jul 2011 08:41:25 +0000</created>
                <updated>Mon, 25 Mar 2013 09:31:04 +0000</updated>
                            <resolved>Fri, 22 Jul 2011 01:23:13 +0000</resolved>
                                    <version>1.0 M3</version>
                                    <fixVersion>1.0 M4</fixVersion>
                                    <component>Mapping</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <timeoriginalestimate seconds="0">0d</timeoriginalestimate>
                            <timeestimate seconds="0">0d</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="71788" author="olivergierke" created="Thu, 21 Jul 2011 15:06:00 +0000"  >&lt;p&gt;As &lt;a href=&quot;https://jira.spring.io/browse/DATAMONGO-192&quot; title=&quot;MappingMongoConverter does not read empty Sets correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DATAMONGO-192&quot;&gt;&lt;del&gt;DATAMONGO-192&lt;/del&gt;&lt;/a&gt; is fixed in master, have you tried a current snapshot? We use the standard Spring &lt;tt&gt;CollectionFactory&lt;/tt&gt; to discover appropriate collection types since the fix.&lt;/p&gt;</comment>
                            <comment id="71790" author="florian.feigenbutz" created="Fri, 22 Jul 2011 00:26:32 +0000"  >&lt;p&gt;I discovered the problem with M3. Before submitting the bug I retried it with yesterday&apos;s snapshot (spring-data-mongodb-1.0.0.BUILD-20110721.083643-330.jar).&lt;br/&gt;
The same problem appeared with both versions.&lt;/p&gt;

&lt;p&gt;After a debugging session I guess that there&apos;s a problem in the current implementation of org.springframework.data.mongodb.core.convert.MappingMongoConverter.readMap(TypeInformation&amp;lt;?&amp;gt;, DBObject) which tries to use findTypeToBeUsed(dbObject) in order to detect the DBObject&apos;s (in this case the java.util.Map) class.&lt;br/&gt;
If no such type is found it falls back to Map.class and uses the core&apos;s CollectionFactory to instanciate the correct implementation:&lt;/p&gt;

&lt;p&gt;Class&amp;lt;?&amp;gt; mapType = customMapType == null ? Map.class : customMapType;&lt;br/&gt;
Map&amp;lt;Object, Object&amp;gt; map = CollectionFactory.createMap(mapType, dbObject.keySet().size());&lt;/p&gt;

&lt;p&gt;Could this probably be fixed by adding a property &quot;_class=java.util.SortedMap&quot; property to embedded Maps? This would cause findTypeToBeUsed(dbObject) to return the correct type.&lt;/p&gt;</comment>
                            <comment id="71799" author="florian.feigenbutz" created="Fri, 22 Jul 2011 00:44:51 +0000"  >&lt;p&gt;Actually - just forgot something.&lt;br/&gt;
The problems appeared after upgrading from Spring Core 3.0.3 to 3.0.5.&lt;/p&gt;

&lt;p&gt;Unfortunately I haven&apos;t been able yet to check for changes in the core&apos;s CollectionFactory between these versions.&lt;/p&gt;</comment>
                            <comment id="71787" author="olivergierke" created="Fri, 22 Jul 2011 01:23:12 +0000"  >&lt;p&gt;It seems we&apos;re suffering from a bug in &lt;tt&gt;MapToMapConverter&lt;/tt&gt; in core Spring framework (see &lt;a href=&quot;https://jira.spring.io/browse/SPR-8554&quot; title=&quot;MapToMapConverter invalidly returns source map for empty maps&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPR-8554&quot;&gt;&lt;del&gt;SPR-8554&lt;/del&gt;&lt;/a&gt;). For empty &lt;tt&gt;Map&lt;/tt&gt; instances it simply returns the source &lt;tt&gt;Map&lt;/tt&gt; instead of forcing a conversion to the given target type. The behaviour you saw was correct as we assume the &lt;tt&gt;ConversionService&lt;/tt&gt; to convert the value to be set into the correct property type.&lt;/p&gt;

&lt;p&gt;We can work around this deficiency quite simply as we get the &lt;tt&gt;TypeInformation&lt;/tt&gt; of the &lt;tt&gt;Map&lt;/tt&gt; handed into the method and thus don&apos;t actually have to fall back on the raw &lt;tt&gt;Map&lt;/tt&gt; interface but can inspect the actual property type.&lt;/p&gt;

&lt;p&gt;Fix is committed and deployed to snapshot repository.&lt;/p&gt;</comment>
                            <comment id="71775" author="florian.feigenbutz" created="Fri, 22 Jul 2011 01:45:12 +0000"  >&lt;p&gt;Thank you for the quick analysis and the fix.&lt;br/&gt;
The problem is solved using the current spring-data-mongodb snapshot.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10151">
                    <name>Relate</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="40506">DATAMONGO-217</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="18954" name="EmptySortedMapTest.java" size="2977" author="florian.feigenbutz" created="Thu, 21 Jul 2011 08:41:25 +0000"/>
                            <attachment id="18957" name="mylyn-context.zip" size="1627" author="olivergierke" created="Fri, 22 Jul 2011 01:23:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 21 Jul 2011 15:06:00 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10280" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>29758</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10182" key="com.atlassian.jira.toolkit:lastupdaterorcommenter">
                        <customfieldname>Last updater</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tmarshall</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i04zin:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>29128</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10381" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Ranking</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24068</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>